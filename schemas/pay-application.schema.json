{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/PayAppPro/aia-pay-application-toolkit/main/schemas/pay-application.schema.json",
  "title": "Pay Application (AIA-Style) Schema",
  "description": "Schema for AIA-style pay application data (G703 line items + optional G702 rollup totals). Educational/reference use only; not a licensed AIA form.",
  "type": "object",
  "additionalProperties": false,
  "required": ["metadata", "schedule_of_values"],
  "properties": {
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["document_type", "currency"],
      "properties": {
        "document_type": {
          "type": "string",
          "description": "Descriptor for the payload (e.g., 'G703 Continuation Sheet (Example)' or 'Pay Application')."
        },
        "project_name": { "type": "string" },
        "project_number": { "type": "string" },
        "application_number": { "type": "integer", "minimum": 1 },
        "period_from": { "type": "string", "format": "date" },
        "period_to": { "type": "string", "format": "date" },

        "contractor_name": { "type": "string" },
        "owner_name": { "type": "string" },
        "architect_name": { "type": "string" },

        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "description": "ISO 4217 currency code, e.g., USD."
        },

        "retainage_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Default retainage percent (0-100). Line items may override this."
        },

        "notes": { "type": "string" }
      }
    },

    "schedule_of_values": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/sovLineItem" }
    },

    "totals": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional roll-up totals (G702-style).",
      "properties": {
        "scheduled_value_total": { "$ref": "#/$defs/money" },
        "work_completed_previous_total": { "$ref": "#/$defs/money" },
        "work_completed_this_period_total": { "$ref": "#/$defs/money" },
        "materials_presently_stored_total": { "$ref": "#/$defs/money" },
        "total_completed_and_stored_to_date": { "$ref": "#/$defs/money" },
        "retainage_held_to_date": { "$ref": "#/$defs/money" },
        "net_earned_less_retainage_to_date": { "$ref": "#/$defs/money" },
        "balance_to_finish_total": { "$ref": "#/$defs/money" }
      }
    },

    "g702_like_fields": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional summary fields commonly presented in a G702-style view.",
      "properties": {
        "original_contract_sum": { "$ref": "#/$defs/money" },
        "net_change_by_change_orders": { "$ref": "#/$defs/money" },
        "contract_sum_to_date": { "$ref": "#/$defs/money" },

        "total_completed_and_stored_to_date": { "$ref": "#/$defs/money" },
        "retainage": { "$ref": "#/$defs/money" },
        "total_earned_less_retainage": { "$ref": "#/$defs/money" },

        "less_previous_certificates_for_payment": { "$ref": "#/$defs/money" },
        "current_payment_due": { "$ref": "#/$defs/money" },
        "balance_to_finish": { "$ref": "#/$defs/money" }
      }
    },

    "calculation_notes": {
      "type": "array",
      "description": "Optional plain-English notes describing assumptions used to compute totals.",
      "items": { "type": "string" }
    }
  },

  "$defs": {
    "money": {
      "type": "number",
      "minimum": 0,
      "multipleOf": 0.01,
      "description": "Currency amount rounded to cents."
    },

    "percent": {
      "type": "number",
      "minimum": 0,
      "maximum": 100
    },

    "retainagePercent": {
      "type": "number",
      "minimum": 0,
      "maximum": 100,
      "description": "Retainage percent expressed as 0-100."
    },

    "sovLineItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["item_no", "description", "scheduled_value"],
      "properties": {
        "item_no": { "type": "integer", "minimum": 1 },
        "description": { "type": "string", "minLength": 1 },

        "scheduled_value": { "$ref": "#/$defs/money" },

        "work_completed_previous": { "$ref": "#/$defs/money" },
        "work_completed_this_period": { "$ref": "#/$defs/money" },
        "materials_presently_stored": { "$ref": "#/$defs/money" },

        "total_completed_and_stored": { "$ref": "#/$defs/money" },
        "percent_complete": { "$ref": "#/$defs/percent" },
        "balance_to_finish": { "$ref": "#/$defs/money" },

        "retainage_percent": { "$ref": "#/$defs/retainagePercent" },
        "retainage_total_to_date": { "$ref": "#/$defs/money" },
        "net_earned_less_retainage": { "$ref": "#/$defs/money" },

        "notes": { "type": "string" }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "total_completed_and_stored": { "type": "number" },
              "scheduled_value": { "type": "number" }
            },
            "required": ["total_completed_and_stored", "scheduled_value"]
          },
          "then": {
            "properties": {
              "total_completed_and_stored": { "maximum": { "$data": "1/scheduled_value" } }
            },
            "description": "Note: JSON Schema $data support varies by validator; treat this as informational."
          }
        }
      ]
    }
  }
}
